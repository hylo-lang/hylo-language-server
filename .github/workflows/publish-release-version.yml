name: Publish release version

on:
  push:
    tags: ["v*.*.*"]

jobs:
  build:
    name: Build and test
    uses: ./.github/workflows/build-and-test-template.yml
    with:
      build-type: release
  publish-release:
    name: Publish release
    needs: [build]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: 'true'

    # Download all architecture-specific artifacts
    - name: Download Linux x64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-Linux-X64
        path: hylo-lsp-linux-x64

    - name: Download Linux ARM64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-Linux-ARM64
        path: hylo-lsp-linux-arm64

    - name: Download macOS x64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-macOS-X64
        path: hylo-lsp-macos-x64

    - name: Download macOS ARM64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-macOS-ARM64
        path: hylo-lsp-macos-arm64

    - name: Download Windows x64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-Windows-X64
        path: hylo-lsp-windows-x64

    - name: Download Windows ARM64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-Windows-ARM64
        path: hylo-lsp-windows-arm64

    - name: Package Hylo release artifacts
      run: |
        set -eo pipefail
        git -C hylo rev-parse HEAD > ref
        cp -Rp hylo/StandardLibrary/Sources hylo-stdlib
        mkdir -p release-artifacts
        
        # Package stdlib
        zip -r release-artifacts/hylo-stdlib.zip hylo-stdlib ref
        
        # Set executable permissions for Unix-like systems
        chmod +x hylo-lsp-linux-x64/* || true
        chmod +x hylo-lsp-linux-arm64/* || true
        chmod +x hylo-lsp-macos-x64/* || true
        chmod +x hylo-lsp-macos-arm64/* || true
        
        # Create version reference file
        echo ${{ github.ref_name }} > ref
        
        # Package language server binaries for each platform and architecture
        # Linux x64
        zip release-artifacts/hylo-lsp-server-linux-x64.zip hylo-lsp-linux-x64/hylo-lsp-server ref
        
        # Linux ARM64
        zip release-artifacts/hylo-lsp-server-linux-arm64.zip hylo-lsp-linux-arm64/hylo-lsp-server ref
        
        # macOS x64
        zip release-artifacts/hylo-lsp-server-macos-x64.zip hylo-lsp-macos-x64/hylo-lsp-server ref
        
        # macOS ARM64 (Apple Silicon)
        zip release-artifacts/hylo-lsp-server-macos-arm64.zip hylo-lsp-macos-arm64/hylo-lsp-server ref
        
        # Windows x64
        zip release-artifacts/hylo-lsp-server-windows-x64.zip hylo-lsp-windows-x64/hylo-lsp-server.exe hylo-lsp-windows-x64/*.dll ref
        
        # Windows ARM64
        zip release-artifacts/hylo-lsp-server-windows-arm64.zip hylo-lsp-windows-arm64/hylo-lsp-server.exe hylo-lsp-windows-arm64/*.dll ref
        
        ls -l release-artifacts

    - name: Extract version changelog
      run: ./extract_version_changelog.sh ${{ github.ref_name }} >> version_changelog.txt

    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          LICENSE
          release-artifacts/*
        body_path: version_changelog.txt
