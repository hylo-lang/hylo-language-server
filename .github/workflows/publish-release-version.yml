name: Publish release version

on:
  push:
    tags: ["v*.*.*"]

jobs:
  build:
    name: Build and test
    uses: ./.github/workflows/build-and-test-template.yml
    with:
      build-type: release
  publish-release:
    name: Publish release
    needs: [build]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: 'true'

    # Download all architecture-specific artifacts
    - name: Download Linux x64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-Linux-X64
        path: hylo-language-server-linux-x64

    - name: Download Linux ARM64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-Linux-ARM64
        path: hylo-language-server-linux-arm64

    - name: Download macOS x64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-macOS-X64
        path: hylo-language-server-macos-x64

    - name: Download macOS ARM64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-macOS-ARM64
        path: hylo-language-server-macos-arm64

    - name: Download Windows x64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-Windows-X64
        path: hylo-language-server-windows-x64

    - name: Download Windows ARM64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-Windows-ARM64
        path: hylo-language-server-windows-arm64

    - name: Package Hylo release artifacts
      run: |
        set -eo pipefail
        mkdir -p release-artifacts

        # Package stdlib
        echo "${{ github.ref_name }}" > "hylo-stdlib/version.txt"

        zip -r release-artifacts/hylo-stdlib.zip hylo-stdlib ref

        # Set executable permissions and create version files for all platforms
        for platform in linux-x64 linux-arm64 macos-x64 macos-arm64; do
          dir="hylo-language-server-${platform}"
          chmod +x "$dir"/* || true
          echo "${{ github.ref_name }}" > "$dir/version.txt"
        done

        # Package language server binaries for each platform
        for platform in linux-x64 linux-arm64 macos-x64 macos-arm64 windows-x64 windows-arm64; do
          dir="hylo-language-server-${platform}"
          cd "$dir"
          zip ../release-artifacts/hylo-language-server-${platform}.zip hylo-language-server version.txt
          cd ..
        done

        ls -l release-artifacts

    - name: Extract version changelog
      run: ./extract_version_changelog.sh ${{ github.ref_name }} >> version_changelog.txt

    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          LICENSE
          release-artifacts/*
        body_path: version_changelog.txt
