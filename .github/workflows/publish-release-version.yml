name: Publish release version

on:
  push:
    tags: ["v*.*.*"]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build:
    name: Build and test
    uses: ./.github/workflows/build-and-test-template.yml
    with:
      build-type: release
      git-ref: ${{ inputs.tag || github.ref }}
  publish-release:
    name: Publish release
    needs: [build]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: 'true'
        ref: ${{ inputs.tag || github.ref }}

    # Download all architecture-specific artifacts
    - name: Download Linux x64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-Linux-X64
        path: hylo-language-server-linux-x64

    - name: Download Linux ARM64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-Linux-ARM64
        path: hylo-language-server-linux-arm64

    - name: Download macOS x64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-macOS-X64
        path: hylo-language-server-macos-x64

    - name: Download macOS ARM64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-macOS-ARM64
        path: hylo-language-server-macos-arm64

    - name: Download Windows x64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-Windows-X64
        path: hylo-language-server-windows-x64

    - name: Download Windows ARM64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-Windows-ARM64
        path: hylo-language-server-windows-arm64

    - name: Package Hylo release artifacts
      run: |
        set -exu pipefail
        git -C hylo-new rev-parse HEAD > version.txt
        mkdir -p release-artifacts

        # Package stdlib
        cp -a hylo-new/StandardLibrary/Sources hylo-standard-library
        echo "${{ inputs.tag || github.ref_name }}" > hylo-standard-library/version.txt

        zip -r release-artifacts/hylo-standard-library.zip hylo-standard-library

        # Package language server binaries for each platform
        for platform in linux-x64 linux-arm64 macos-x64 macos-arm64 windows-x64 windows-arm64; do
          cd "hylo-language-server-${platform}"
          echo "${{ inputs.tag || github.ref_name }}" > version.txt
          
          # Determine executable name based on platform
          if [[ "$platform" == windows-* ]]; then
            executable="hylo-language-server.exe"
          else
            executable="hylo-language-server"
            chmod +x "$executable" # Make it executable on unix
          fi

          # The standard library bundle/resource name differs on macOS vs others
          if [[ "$platform" == macos-* ]]; then
            stdlib="Hylo_StandardLibrary.bundle"
          else
            stdlib="Hylo_StandardLibrary.resources"
          fi
          
          zip -r ../release-artifacts/hylo-language-server-${platform}.zip "$executable" version.txt "$stdlib"
          cd ..
        done

        ls -l release-artifacts

    - name: Extract version changelog
      run: ./extract_version_changelog.sh ${{ inputs.tag || github.ref_name }} >> version_changelog.txt

    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ inputs.tag || github.ref_name }}
        files: |
          LICENSE
          release-artifacts/*
        body_path: version_changelog.txt
