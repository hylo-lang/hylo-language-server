name: Publish release version

on:
  push:
    tags: ["v*.*.*"]

jobs:
  build:
    name: Build and test
    uses: ./.github/workflows/build-and-test-template.yml
    with:
      build-type: release
  publish-release:
    name: Publish release
    needs: [build]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: 'true'

    # Download all architecture-specific artifacts
    - name: Download Linux x64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-Linux-X64
        path: hylo-language-server-linux-x64

    - name: Download Linux ARM64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-Linux-ARM64
        path: hylo-language-server-linux-arm64

    - name: Download macOS x64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-macOS-X64
        path: hylo-language-server-macos-x64

    - name: Download macOS ARM64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-macOS-ARM64
        path: hylo-language-server-macos-arm64

    - name: Download Windows x64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-Windows-X64
        path: hylo-language-server-windows-x64

    - name: Download Windows ARM64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: hylo-language-server-Windows-ARM64
        path: hylo-language-server-windows-arm64

    - name: Package Hylo release artifacts
      run: |
        set -exu pipefail
        git -C hylo-new rev-parse HEAD > version.txt
        cp -Rp hylo-new/StandardLibrary/Sources hylo-stdlib
        mkdir -p release-artifacts

        # Package stdlib
        echo "${{ github.ref_name }}" > "hylo-stdlib/version.txt"

        zip -r release-artifacts/hylo-stdlib.zip hylo-standard-library

        # Package language server binaries for each platform
        for platform in linux-x64 linux-arm64 macos-x64 macos-arm64 windows-x64 windows-arm64; do
          cd "hylo-language-server-${platform}"
          echo "${{ github.ref_name }}" > version.txt
          
          # Copy StandardLibrary into the platform directory
          cp -Rp ../hylo-new/StandardLibrary/Sources hylo-standard-library
          
          # Determine executable name based on platform
          if [[ "$platform" == windows-* ]]; then
            executable="hylo-language-server.exe"
          else
            executable="hylo-language-server"
            chmod +x "$executable" # Make it executable on unix
          fi
          
          zip -r ../release-artifacts/hylo-language-server-${platform}.zip "$executable" version.txt hylo-standard-library
          cd ..
        done

        ls -l release-artifacts

    - name: Extract version changelog
      run: ./extract_version_changelog.sh ${{ github.ref_name }} >> version_changelog.txt

    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          LICENSE
          release-artifacts/*
        body_path: version_changelog.txt
